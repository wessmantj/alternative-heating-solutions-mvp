<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today's Leads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* San Francisco Font */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, sans-serif;
        }
        
        /* Sticky header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Sticky Header with Stats -->
    <div class="sticky-header bg-white border-b-2 border-teal-500 p-4 shadow-sm">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Work Queue</h1>
        <p class="text-xs text-gray-500">Last 72 hours ‚Ä¢ Oldest first</p>
        <div class="text-sm text-gray-600">
            Total Today: {{ stats.total_leads_today }} | 
            Need to Call: {{ stats.new }} | 
            Called: {{ stats.called_back }}
        </div>
    </div>
    
    <!-- Lead List -->
    <div class="p-4">
        {% if leads %}
            {% set current_date = '' %}
            {% for lead in leads %}
                <!-- Date separator -->
                {% set lead_date = lead.created_at[:10] %}
                {% if lead_date != current_date %}
                    {% set current_date = lead_date %}
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mt-4 mb-2 first:mt-0">
                        {{ lead.created_at[:10] }}
                    </div>
                {% endif %}
                
                <!--  Made clickable with onclick -->
                <div onclick="openModal({{ lead.id }})" class="bg-white border border-gray-200 rounded-lg p-4 mb-3 shadow-sm cursor-pointer hover:shadow-md transition-shadow">
                    
                    <!-- Lead Header (Name, Time, Checkbox) -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-900">{{ lead.name or 'No name' }}</h3>
                            <p class="text-gray-500 text-sm">{{ lead.created_at }}</p>
                        </div>
                        
                        <!-- Toggleable Checkbox -->
                        <div class="ml-4" onclick="event.stopPropagation()">
                            {% if lead.status == 'called_back' or lead.status == 'scheduled' %}
                                <a href="{{ url_for('toggle_status', lead_id=lead.id) }}" 
                                   class="text-teal-600 text-2xl hover:text-teal-700">
                                    ‚úì
                                </a>
                            {% else %}
                                <a href="{{ url_for('toggle_status', lead_id=lead.id) }}" 
                                   class="text-gray-400 text-2xl hover:text-teal-600">
                                    ‚òê
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Phone Number (Click to Call) -->
                    <a href="tel:{{ lead.customer_phone }}" 
                       onclick="event.stopPropagation()"
                       class="block text-teal-600 text-xl font-semibold mb-2 hover:text-teal-700">
                        üìû {{ lead.customer_phone }}
                    </a>
                    
                    <!-- Address -->
                    <p class="text-gray-700 mb-1">
                        <strong>üìç Address:</strong> {{ lead.address or 'No address provided' }}
                    </p>
                    
                    <!-- Service -->
                    <p class="text-gray-700">
                        <strong>Service:</strong> {{ lead.service or 'No service specified' }}
                    </p>
                    
                </div>
            {% endfor %}
        {% else %}
            <!-- No leads -->
            <div class="bg-white border border-gray-200 rounded-lg p-8 text-center text-gray-500">
                <p class="text-xl">No leads in the last 72 hours</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Lead Detail Modal -->
    <div id="leadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center">
                <h2 id="modalName" class="text-xl font-bold text-gray-900"></h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">
                    √ó
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-4">
                <!-- Status -->
                <div class="mb-4">
                    <span id="modalStatus" class="inline-block px-3 py-1 rounded-full text-sm font-semibold"></span>
                </div>
                
                <!-- Phone -->
                <div class="mb-4">
                    <a id="modalPhone" href="" class="block text-teal-600 text-2xl font-semibold hover:text-teal-700"></a>
                </div>
                
                <!-- Address -->
                <div class="mb-4">
                    <p class="text-gray-600 text-sm font-semibold mb-1">Address</p>
                    <p id="modalAddress" class="text-gray-900"></p>
                </div>
                
                <!-- Service -->
                <div class="mb-4">
                    <p class="text-gray-600 text-sm font-semibold mb-1">Service</p>
                    <p id="modalService" class="text-gray-900"></p>
                </div>
                
                <!-- Time -->
                <div class="mb-4">
                    <p class="text-gray-600 text-sm font-semibold mb-1">Received</p>
                    <p id="modalTime" class="text-gray-900"></p>
                </div>
                
                <!-- Original Message -->
                <div id="originalMessageSection" class="mb-4 hidden">
                    <p class="text-gray-600 text-sm font-semibold mb-2">Original Message</p>
                    <div class="bg-gray-50 border border-gray-200 rounded p-3">
                        <pre id="modalOriginalMessage" class="text-sm text-gray-700 whitespace-pre-wrap font-sans"></pre>
                    </div>
                </div>
                
                <!-- Voicemail -->
                <div id="voicemailSection" class="mb-4 hidden">
                    <p class="text-gray-600 text-sm font-semibold mb-2">Voicemail</p>
                    <audio id="modalVoicemail" controls class="w-full">
                        <source src="" type="audio/mpeg">
                    </audio>
                </div>
                
                <!-- Notes -->
                <div class="mb-4">
                    <p class="text-gray-600 text-sm font-semibold mb-2">Notes</p>
                    <textarea id="modalNotes" class="w-full border border-gray-300 rounded p-2 text-sm" rows="3" placeholder="Add notes here..."></textarea>
                    <button onclick="saveNotes()" class="mt-2 px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 text-sm">
                        Save Notes
                    </button>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        let currentLeadId = null;

        function openModal(leadId) {
            currentLeadId = leadId;
            
            // Fetch lead data
            fetch(`/api/lead/${leadId}`)
                .then(response => response.json())
                .then(lead => {
                    // Populate modal
                    document.getElementById('modalName').textContent = lead.name || 'No name';
                    document.getElementById('modalPhone').href = `tel:${lead.customer_phone}`;
                    document.getElementById('modalPhone').textContent = `üìû ${lead.customer_phone}`;
                    document.getElementById('modalAddress').textContent = lead.address || 'No address provided';
                    document.getElementById('modalService').textContent = lead.service || 'No service specified';
                    document.getElementById('modalTime').textContent = lead.created_at;
                    document.getElementById('modalNotes').value = lead.notes || '';
                    
                    // Status badge
                    const statusEl = document.getElementById('modalStatus');
                    if (lead.status === 'called_back') {
                        statusEl.textContent = '‚úì Called Back';
                        statusEl.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-teal-100 text-teal-800';
                    } else if (lead.status === 'scheduled') {
                        statusEl.textContent = 'üìÖ Scheduled';
                        statusEl.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800';
                    } else {
                        statusEl.textContent = 'New';
                        statusEl.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-800';
                    }
                    
                    // Show/hide original message
                    if (lead.original_message) {
                        document.getElementById('modalOriginalMessage').textContent = lead.original_message;
                        document.getElementById('originalMessageSection').classList.remove('hidden');
                    } else {
                        document.getElementById('originalMessageSection').classList.add('hidden');
                    }
                    
                    // Show/hide voicemail
                    if (lead.voicemail_url) {
                        document.getElementById('modalVoicemail').src = lead.voicemail_url;
                        document.getElementById('voicemailSection').classList.remove('hidden');
                    } else {
                        document.getElementById('voicemailSection').classList.add('hidden');
                    }
                    
                    // Show modal
                    document.getElementById('leadModal').classList.remove('hidden');
                });
        }

        function closeModal() {
            document.getElementById('leadModal').classList.add('hidden');
            currentLeadId = null;
        }

        function saveNotes() {
            const notes = document.getElementById('modalNotes').value;
            
            fetch(`/api/lead/${currentLeadId}/notes`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({notes: notes})
            })
            .then(() => {
                alert('Notes saved!');
            });
        }

        function markStatus(status) {
            // Update status then close modal and refresh page
            fetch(`/api/lead/${currentLeadId}/status`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: status})
            })
            .then(() => {
                closeModal();
                window.location.reload();
            });
        }

        // Close modal when clicking outside
        document.getElementById('leadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
    
</body>
</html>